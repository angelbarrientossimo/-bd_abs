# PR0501. Ingesta de datos de ficheros CSV

## ------------- ESPECIALIZACIÓN EN INTELIGENCIA ARTIFICIAL Y BIG DATA -------------
---------------------------------------------------------------------------------

Módulo:                     BIG DATA APLICADO
Profesor:                   Víctor J. González
Unidad de Trabajo:          UT05. Procesamiento distribuido con PySpark
PR0501. Ingesta de datos de ficheros CSV
Resultados de aprendizaje:  RA1

# PR0501. Ingesta de datos de ficheros CSV

En esta primera práctica practicaremos con la carga de datos en dataframes de Spark. Para cada uno de los ejercicios tienes que cargar el dataset referenciado definiendo tú previamente el esquema. Una vez que lo hayas hecho muestra el esquema del dataframe y muestra los 5 primeros registros.

### Dataset 1: Datos para la predicción del rendimiento en cultivos


```python
from pyspark.sql import SparkSession

try:
    spark = ( SparkSession.builder
                .appName("angel_spark")
                .master("spark://spark-master:7077")
                .getOrCreate()
            )
    print("SparkSession iniciada correctamente.")
except Exception as e:
    print("Error en la conexion")
    print(e)

```

    Setting default log level to "WARN".
    To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
    26/01/15 09:54:16 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable


    SparkSession iniciada correctamente.



```python
!head -n2 ./crop*
```

    Crop,Region,Soil_Type,Soil_pH,Rainfall_mm,Temperature_C,Humidity_pct,Fertilizer_Used_kg,Irrigation,Pesticides_Used_kg,Planting_Density,Previous_Crop,Yield_ton_per_ha
    Maize,Region_C,Sandy,7.01,1485.4,19.7,40.3,105.1,Drip,10.2,23.2,Rice,101.48



```python
from pyspark.sql.types import StructType, StructField, StringType, DoubleType, BooleanType,IntegerType, LongType
```


```python
schema = StructType([
    StructField("Crop",StringType(),True),
    StructField("Region",StringType(),True),
    StructField("Soil_Type",StringType(),True),
    StructField("Soil_pH",DoubleType(),True),
    StructField("Rainfall_mm",DoubleType(),True),
    StructField("Temperature_C",DoubleType(),True),
    StructField("Humidity_pct",DoubleType(),True),
    StructField("Fertilizer_Used_kg",DoubleType(),True),
    StructField("Irrigation",StringType(),True),
    StructField("Pesticides_Used_kg",DoubleType(),True),
    StructField("Planting_Density",DoubleType(),True),
    StructField("Previous_Crop",StringType(),True),
    StructField("Yield_ton_per_ha",DoubleType(),True)
])
```


```python
schema.fields
```




    [StructField('Crop', StringType(), True),
     StructField('Region', StringType(), True),
     StructField('Soil_Type', StringType(), True),
     StructField('Soil_pH', DoubleType(), True),
     StructField('Rainfall_mm', DoubleType(), True),
     StructField('Temperature_C', DoubleType(), True),
     StructField('Humidity_pct', DoubleType(), True),
     StructField('Fertilizer_Used_kg', DoubleType(), True),
     StructField('Irrigation', StringType(), True),
     StructField('Pesticides_Used_kg', DoubleType(), True),
     StructField('Planting_Density', DoubleType(), True),
     StructField('Previous_Crop', StringType(), True),
     StructField('Yield_ton_per_ha', DoubleType(), True)]




```python
df = (spark.read
        .format("csv")
        .option("header","true")
        .schema(schema)
        .load("./crop_yield_dataset.csv")
     )
```


```python
df.printSchema()
df.show(5)
```

    root
     |-- Crop: string (nullable = true)
     |-- Region: string (nullable = true)
     |-- Soil_Type: string (nullable = true)
     |-- Soil_pH: double (nullable = true)
     |-- Rainfall_mm: double (nullable = true)
     |-- Temperature_C: double (nullable = true)
     |-- Humidity_pct: double (nullable = true)
     |-- Fertilizer_Used_kg: double (nullable = true)
     |-- Irrigation: string (nullable = true)
     |-- Pesticides_Used_kg: double (nullable = true)
     |-- Planting_Density: double (nullable = true)
     |-- Previous_Crop: string (nullable = true)
     |-- Yield_ton_per_ha: double (nullable = true)
    


                                                                                    

    +------+--------+---------+-------+-----------+-------------+------------+------------------+----------+------------------+----------------+-------------+----------------+
    |  Crop|  Region|Soil_Type|Soil_pH|Rainfall_mm|Temperature_C|Humidity_pct|Fertilizer_Used_kg|Irrigation|Pesticides_Used_kg|Planting_Density|Previous_Crop|Yield_ton_per_ha|
    +------+--------+---------+-------+-----------+-------------+------------+------------------+----------+------------------+----------------+-------------+----------------+
    | Maize|Region_C|    Sandy|   7.01|     1485.4|         19.7|        40.3|             105.1|      Drip|              10.2|            23.2|         Rice|          101.48|
    |Barley|Region_D|     Loam|   5.79|      399.4|         29.1|        55.4|             221.8| Sprinkler|              35.5|             7.4|       Barley|          127.39|
    |  Rice|Region_C|     Clay|   7.24|      980.9|         30.5|        74.4|              61.2| Sprinkler|              40.0|             5.1|        Wheat|           68.99|
    | Maize|Region_D|     Loam|   6.79|     1054.3|         26.4|        62.0|             257.8|      Drip|              42.7|            23.7|         None|          169.06|
    | Maize|Region_D|    Sandy|   5.96|      744.6|         20.4|        70.9|             195.8|      Drip|              25.5|            15.6|        Maize|          118.71|
    +------+--------+---------+-------+-----------+-------------+------------+------------------+----------+------------------+----------------+-------------+----------------+
    only showing top 5 rows
    


    26/01/15 09:54:36 WARN GarbageCollectionMetrics: To enable non-built-in garbage collector(s) List(G1 Concurrent GC), users should configure it(them) to spark.eventLog.gcMetrics.youngGenerationGarbageCollectors or spark.eventLog.gcMetrics.oldGenerationGarbageCollectors


### Dataset cultivos

Kaggle: Smart Crop yield predication dataset

### Dataset 2: Lugares famosos del mundo


```python
!head -n2 ./world*
```

    Place_Name,Country,City,Annual_Visitors_Millions,Type,UNESCO_World_Heritage,Year_Built,Entry_Fee_USD,Best_Visit_Month,Region,Tourism_Revenue_Million_USD,Average_Visit_Duration_Hours,Famous_For
    Eiffel Tower,France,Paris,7,Monument/Tower,No,1889,35,May-June/Sept-Oct,Western Europe,95,2.5,"Iconic iron lattice tower, symbol of Paris"



```python
schema1 = StructType([
    StructField("Place_Name",StringType(),True),
    StructField("Country",StringType(),True),
    StructField("City",StringType(),True),
    StructField("Annual_Visitors_Millions",IntegerType(),True),
    StructField("Type",StringType(),True),
    StructField("UNESCO_World_Heritage",StringType(),True),
    StructField("Year_Built",IntegerType(),True),
    StructField("Entry_Fee_USD",IntegerType(),True),
    StructField("Best_Visit_Month",StringType(),True),
    StructField("Region",StringType(),True),
    StructField("Tourism_Revenue_Million_USD",IntegerType(),True),
    StructField("Average_Visit_Duration_Hours",DoubleType(),True),
    StructField("Famous_For",StringType(),True)
])
df2 = (spark.read
        .format("csv")
        .option("header","true")
        .schema(schema1)
        .load("./world_famous_places_2024.csv")
     )
df2.printSchema()
df2.show(5)
```

    root
     |-- Place_Name: string (nullable = true)
     |-- Country: string (nullable = true)
     |-- City: string (nullable = true)
     |-- Annual_Visitors_Millions: integer (nullable = true)
     |-- Type: string (nullable = true)
     |-- UNESCO_World_Heritage: string (nullable = true)
     |-- Year_Built: integer (nullable = true)
     |-- Entry_Fee_USD: integer (nullable = true)
     |-- Best_Visit_Month: string (nullable = true)
     |-- Region: string (nullable = true)
     |-- Tourism_Revenue_Million_USD: integer (nullable = true)
     |-- Average_Visit_Duration_Hours: double (nullable = true)
     |-- Famous_For: string (nullable = true)
    
    +-------------------+-------------+----------------+------------------------+------------------+---------------------+----------+-------------+-----------------+--------------+---------------------------+----------------------------+--------------------+
    |         Place_Name|      Country|            City|Annual_Visitors_Millions|              Type|UNESCO_World_Heritage|Year_Built|Entry_Fee_USD| Best_Visit_Month|        Region|Tourism_Revenue_Million_USD|Average_Visit_Duration_Hours|          Famous_For|
    +-------------------+-------------+----------------+------------------------+------------------+---------------------+----------+-------------+-----------------+--------------+---------------------------+----------------------------+--------------------+
    |       Eiffel Tower|       France|           Paris|                       7|    Monument/Tower|                   No|      1889|           35|May-June/Sept-Oct|Western Europe|                         95|                         2.5|Iconic iron latti...|
    |       Times Square|United States|   New York City|                      50|    Urban Landmark|                   No|      1904|            0|Apr-June/Sept-Nov| North America|                         70|                         1.5|Bright lights, Br...|
    |      Louvre Museum|       France|           Paris|                    NULL|            Museum|                  Yes|      1793|           22|        Oct-March|Western Europe|                        120|                         4.0|World's most visi...|
    |Great Wall of China|        China|Beijing/Multiple|                      10| Historic Monument|                  Yes|      NULL|           10| Apr-May/Sept-Oct|     East Asia|                        180|                         4.0|Ancient defensive...|
    |          Taj Mahal|        India|            Agra|                    NULL|Monument/Mausoleum|                  Yes|      1653|           15|        Oct-March|    South Asia|                         65|                         2.0|White marble maus...|
    +-------------------+-------------+----------------+------------------------+------------------+---------------------+----------+-------------+-----------------+--------------+---------------------------+----------------------------+--------------------+
    only showing top 5 rows
    


### Dataset 3: Registro turístico de Castilla y León

Dataset registro turístico

Datos Abierto Junta de Castilla y León: Registro turístico completo (CSV)


```python
!head -n2 ./registro*
```

    establecimiento;n_registro;codigo;tipo;categoria;especialidades;clase;nombre;direccion;c_postal;provincia;municipio;localidad;nucleo;telefono_1;telefono_2;telefono_3;email;web;q_calidad;posada_real;plazas;gps_longitud;gps_latitud;accesible_a_personas_con_discapacidad;column_27;posicion
    Turismo Activo;47/000047;;Profesional de Turismo Activo;;;;BERNARDO MORO MENENDEZ;Calle Rio Somiedo 1  2º C;33840;Asturias;Somiedo;POLA DE SOMIEDO;POLA DE SOMIEDO;616367277;;;bernardomoro@hotmail.com;;;;;;;;;



```python
schema2 = StructType([
    StructField("establecimiento",StringType(),True),
    StructField("n_registro",StringType(),True),
    StructField("codigo",StringType(),True),
    StructField("tipo",StringType(),True),
    StructField("categoria",StringType(),True),
    StructField("especialidades",StringType(),True),
    StructField("clase",StringType(),True),
    StructField("nombre",StringType(),True),
    StructField("direccion",StringType(),True),
    StructField("c_postal",IntegerType(),True),
    StructField("provincia",StringType(),True),
    StructField("municipio",StringType(),True),
    StructField("localidad",StringType(),True),
    StructField("nucleo",StringType(),True),
    StructField("telefono_1",LongType(),True),
    StructField("telefono_2",LongType(),True),
    StructField("telefono_3",LongType(),True),
    StructField("email",StringType(),True),
    StructField("web",StringType(),True),
    StructField("q_calidad",StringType(),True),
    StructField("posada_real",StringType(),True),
    StructField("plazas",IntegerType(),True),
    StructField("gps_longitud",DoubleType(),True),
    StructField("gps_latitud",DoubleType(),True),
    StructField("accesible_a_personas_con_discapacidad",StringType(),True),
    StructField("column_27",StringType(),True),
    StructField("posicion",StringType(),True),

])
df3 = (spark.read
        .format("csv")
        .option("header","true")
        .option("quote",";")
        .schema(schema2)
        .load("./world_famous_places_2024.csv")
     )
df3.printSchema()
df3.show(5)
```

    root
     |-- establecimiento: string (nullable = true)
     |-- n_registro: string (nullable = true)
     |-- codigo: string (nullable = true)
     |-- tipo: string (nullable = true)
     |-- categoria: string (nullable = true)
     |-- especialidades: string (nullable = true)
     |-- clase: string (nullable = true)
     |-- nombre: string (nullable = true)
     |-- direccion: string (nullable = true)
     |-- c_postal: integer (nullable = true)
     |-- provincia: string (nullable = true)
     |-- municipio: string (nullable = true)
     |-- localidad: string (nullable = true)
     |-- nucleo: string (nullable = true)
     |-- telefono_1: long (nullable = true)
     |-- telefono_2: long (nullable = true)
     |-- telefono_3: long (nullable = true)
     |-- email: string (nullable = true)
     |-- web: string (nullable = true)
     |-- q_calidad: string (nullable = true)
     |-- posada_real: string (nullable = true)
     |-- plazas: integer (nullable = true)
     |-- gps_longitud: double (nullable = true)
     |-- gps_latitud: double (nullable = true)
     |-- accesible_a_personas_con_discapacidad: string (nullable = true)
     |-- column_27: string (nullable = true)
     |-- posicion: string (nullable = true)
    
    +-------------------+-------------+----------------+----+------------------+--------------+----------------+------+-----------------+--------+---------+---------+--------------------+-------------------+----------+----------+----------+-----+----+---------+-----------+------+------------+-----------+-------------------------------------+---------+--------+
    |    establecimiento|   n_registro|          codigo|tipo|         categoria|especialidades|           clase|nombre|        direccion|c_postal|provincia|municipio|           localidad|             nucleo|telefono_1|telefono_2|telefono_3|email| web|q_calidad|posada_real|plazas|gps_longitud|gps_latitud|accesible_a_personas_con_discapacidad|column_27|posicion|
    +-------------------+-------------+----------------+----+------------------+--------------+----------------+------+-----------------+--------+---------+---------+--------------------+-------------------+----------+----------+----------+-----+----+---------+-----------+------+------------+-----------+-------------------------------------+---------+--------+
    |       Eiffel Tower|       France|           Paris|   7|    Monument/Tower|            No|            1889|    35|May-June/Sept-Oct|    NULL|       95|      2.5|"Iconic iron latt...|   symbol of Paris"|      NULL|      NULL|      NULL| NULL|NULL|     NULL|       NULL|  NULL|        NULL|       NULL|                                 NULL|     NULL|    NULL|
    |       Times Square|United States|   New York City|  50|    Urban Landmark|            No|            1904|     0|Apr-June/Sept-Nov|    NULL|       70|      1.5|      "Bright lights|     Broadway shows|      NULL|      NULL|      NULL| NULL|NULL|     NULL|       NULL|  NULL|        NULL|       NULL|                                 NULL|     NULL|    NULL|
    |      Louvre Museum|       France|           Paris| 8.7|            Museum|           Yes|            1793|    22|        Oct-March|    NULL|      120|        4|"World's most vis...| home to Mona Lisa"|      NULL|      NULL|      NULL| NULL|NULL|     NULL|       NULL|  NULL|        NULL|       NULL|                                 NULL|     NULL|    NULL|
    |Great Wall of China|        China|Beijing/Multiple|  10| Historic Monument|           Yes|220 BC - 1644 AD|    10| Apr-May/Sept-Oct|    NULL|      180|        4|Ancient defensive...|               NULL|      NULL|      NULL|      NULL| NULL|NULL|     NULL|       NULL|  NULL|        NULL|       NULL|                                 NULL|     NULL|    NULL|
    |          Taj Mahal|        India|            Agra| 7.5|Monument/Mausoleum|           Yes|            1653|    15|        Oct-March|    NULL|       65|        2|"White marble mau...|    symbol of love"|      NULL|      NULL|      NULL| NULL|NULL|     NULL|       NULL|  NULL|        NULL|       NULL|                                 NULL|     NULL|    NULL|
    +-------------------+-------------+----------------+----+------------------+--------------+----------------+------+-----------------+--------+---------+---------+--------------------+-------------------+----------+----------+----------+-----+----+---------+-----------+------+------------+-----------+-------------------------------------+---------+--------+
    only showing top 5 rows
    

