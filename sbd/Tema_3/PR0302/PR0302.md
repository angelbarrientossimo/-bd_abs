------------- ESPECIALIZACIÓN EN INTELIGENCIA ARTIFICIAL Y BIG DATA -------------
---------------------------------------------------------------------------------

Módulo:                     SISTEMAS DE BIG DATA

Profesor:                   Víctor J. González

Unidad de Trabajo:          UT03. Gestión de los datos

Práctica:                   PR0302: Lectura avanzada de datos de archivos

Resultados de aprendizaje:  

### PR0302: Lectura avanzada de datos de archivos

##### Objetivo de la Práctica

Esta práctica es una revisión de la anterior donde aumentamos el nivel de dificultad ya que los archivos de origen tienen sus peculiaridades.

Nuevamente tienes que leer datos de tres fuentes diferentes (CSV, Excel y JSON) y volcar el resultado a un archivo CSV.

Las fuentes son:

##### Norte (ventas_norte_v2.csv):

Formato CSV delimitado por punto y coma (;).

El campo Direccion_Envio contiene comas reales (ej: “Calle Mayor, 12”). Debes asegurarte de que Pandas no rompa las filas al leerlo.

El campo Total_Factura viene como texto con símbolos de moneda (ej: “$1,200.50”). Deberás limpiarlo y convertirlo a float.




```python
def function(x):
    return float(x.replace("$",""))


df = pd.read_csv("ventas_norte_v2.csv",sep=";",converters={"Total_Factura": function},dtype={"Total_Facturas":float})
df.head(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID_Pedido</th>
      <th>Fecha_Transaccion</th>
      <th>Cliente_Nombre</th>
      <th>Direccion_Envio</th>
      <th>Producto</th>
      <th>Unidades</th>
      <th>Precio_Unitario</th>
      <th>Total_Factura</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>N-1000</td>
      <td>2023-05-10 03:00:00</td>
      <td>Usuario_0</td>
      <td>Gran Vía, 49, Piso 4</td>
      <td>Laptop Gamer</td>
      <td>1</td>
      <td>970</td>
      <td>970.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>N-1001</td>
      <td>2023-06-18 09:00:00</td>
      <td>Usuario_1</td>
      <td>Av. Libertad, 30, Piso 4</td>
      <td>Mouse Ergonómico</td>
      <td>4</td>
      <td>927</td>
      <td>3708.0</td>
    </tr>
  </tbody>
</table>
</div>



##### Sur (ventas_sur.xlsx):

Archivo Excel con múltiples hojas (Q1_2023, Q2_2023).

Contiene columnas booleanas (Es_Cliente_Corporativo) y de estado (Estado_Envio) que deben conservarse.

Debes calcular una columna Total que no existe explícitamente (Precio_Base * Cantidad * (1 - Descuento_Aplicado)).



```python
df = pd.read_excel("ventas_sur_v2.xlsx",sheet_name=None)
df = pd.concat(df.values(),ignore_index=True)
df["Total"] = df["Precio_Base"] * df["Cantidad"] * (1 - df["Descuento_Aplicado"])
df.head(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ref_Venta</th>
      <th>Fecha_Alta</th>
      <th>Articulo</th>
      <th>Cantidad</th>
      <th>Precio_Base</th>
      <th>Descuento_Aplicado</th>
      <th>Es_Cliente_Corporativo</th>
      <th>Estado_Envio</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>S-5000</td>
      <td>2023-02-11 00:00:00</td>
      <td>Webcam HD</td>
      <td>9</td>
      <td>425.12</td>
      <td>0.2</td>
      <td>False</td>
      <td>Enviado</td>
      <td>3060.864</td>
    </tr>
    <tr>
      <th>1</th>
      <td>S-5001</td>
      <td>2023-02-03 12:00:00</td>
      <td>Teclado Mecánico</td>
      <td>8</td>
      <td>599.60</td>
      <td>0.0</td>
      <td>True</td>
      <td>Devuelto</td>
      <td>4796.800</td>
    </tr>
  </tbody>
</table>
</div>



##### Este (ventas_este.json):

JSON de con varios niveles de anidamiento

La información útil está sepultada bajo data -> payload -> transaccion.

Debes extraer:

    - ID del registro.
    - Fecha.
    - Ciudad del comprador.
    - Nombre del producto.
    - Cantidad.
    - Precio de lista y el monto del IVA (que está en un sub-diccionario).
Debes descartar metadatos técnicos (latency_ms, source_system).

El DataFrame final debe tener exactamente estas columnas estandarizadas:

    - id_transaccion
    - fecha
    - region
    - producto
    - cantidad
    - total_venta
    - ciudad


```python
import json
import pandas as pd

with open("ventas_este_v2.json") as f:
    data = json.load(f)

df = pd.json_normalize(data)


df = df[
    [
        "data.id_registro",
        "data.payload.fecha_evento",
        "data.payload.comprador.ubicacion.ciudad",
        "data.payload.transaccion.detalles_producto.nombre_comercial",
        "data.payload.transaccion.cantidad_comprada",
        "data.payload.transaccion.detalles_producto.precio_lista",
        "data.payload.transaccion.detalles_producto.impuestos.monto_iva"
    ]
]

df = df.rename(columns={
    "data.id_registro": "id_Transaccion",
    "data.payload.fecha_evento": "Fecha",
    "data.payload.comprador.ubicacion.ciudad": "Ciudad",
    "data.payload.transaccion.detalles_producto.nombre_comercial": "Producto",
    "data.payload.transaccion.cantidad_comprada": "Cantidad",
    "data.payload.transaccion.detalles_producto.precio_lista": "Total_Venta",
    "data.payload.transaccion.detalles_producto.impuestos.monto_iva": "Iva"
})

df.head(10)




```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_Transaccion</th>
      <th>Fecha</th>
      <th>Ciudad</th>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Total_Venta</th>
      <th>Iva</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>E-8000</td>
      <td>2023-06-29 00:00:00</td>
      <td>Sevilla</td>
      <td>Monitor 4K</td>
      <td>1</td>
      <td>503</td>
      <td>105.63</td>
    </tr>
    <tr>
      <th>1</th>
      <td>E-8001</td>
      <td>2023-04-12 00:00:00</td>
      <td>Sevilla</td>
      <td>Webcam HD</td>
      <td>1</td>
      <td>1122</td>
      <td>235.62</td>
    </tr>
    <tr>
      <th>2</th>
      <td>E-8002</td>
      <td>2023-04-20 00:00:00</td>
      <td>Sevilla</td>
      <td>Webcam HD</td>
      <td>2</td>
      <td>994</td>
      <td>208.74</td>
    </tr>
    <tr>
      <th>3</th>
      <td>E-8003</td>
      <td>2023-04-14 00:00:00</td>
      <td>Madrid</td>
      <td>Webcam HD</td>
      <td>2</td>
      <td>1255</td>
      <td>263.55</td>
    </tr>
    <tr>
      <th>4</th>
      <td>E-8004</td>
      <td>2023-01-03 00:00:00</td>
      <td>Sevilla</td>
      <td>Monitor 4K</td>
      <td>2</td>
      <td>1458</td>
      <td>306.18</td>
    </tr>
    <tr>
      <th>5</th>
      <td>E-8005</td>
      <td>2023-02-24 00:00:00</td>
      <td>Valencia</td>
      <td>Teclado Mecánico</td>
      <td>2</td>
      <td>475</td>
      <td>99.75</td>
    </tr>
    <tr>
      <th>6</th>
      <td>E-8006</td>
      <td>2023-05-14 00:00:00</td>
      <td>Sevilla</td>
      <td>Mouse Ergonómico</td>
      <td>2</td>
      <td>498</td>
      <td>104.58</td>
    </tr>
    <tr>
      <th>7</th>
      <td>E-8007</td>
      <td>2023-02-22 00:00:00</td>
      <td>Valencia</td>
      <td>Webcam HD</td>
      <td>2</td>
      <td>1255</td>
      <td>263.55</td>
    </tr>
    <tr>
      <th>8</th>
      <td>E-8008</td>
      <td>2023-03-27 00:00:00</td>
      <td>Madrid</td>
      <td>Laptop Gamer</td>
      <td>2</td>
      <td>668</td>
      <td>140.28</td>
    </tr>
    <tr>
      <th>9</th>
      <td>E-8009</td>
      <td>2023-03-22 00:00:00</td>
      <td>Sevilla</td>
      <td>Docking Station</td>
      <td>1</td>
      <td>933</td>
      <td>195.93</td>
    </tr>
  </tbody>
</table>
</div>


