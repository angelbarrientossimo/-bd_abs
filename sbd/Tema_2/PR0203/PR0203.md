```python
!pip install redis
```

    Requirement already satisfied: redis in /opt/conda/lib/python3.11/site-packages (7.0.1)



```python
#Importamos redis
import redis
r = redis.Redis(
	host='redis',
	port=6379,
	db=0,
	decode_responses=True
)
import json
```


```python
# Crear el hash player:<id> con los campos: name, country, games_played, score
# Le añadimos al sorted set leaderboard con un vaor inicial de 100
player = 0
def add_player(name, country):
    cadena= "player:"
    global player
    player += 1
    cadena += str(player)
    r.hset(cadena, mapping={
    "name": name,
    "country": country,
    "score": 100,
    "games_played": 0
    })
    r.zadd("leaderboard",{cadena:100})
    

add_player("angel","España")
add_player("miguel","España")
add_player("prueba","España")
add_player("hola","España")
```


```python
#Comprobamos que se ha añadido
r.hget( "player:1","name")

```


```python
#Para actualizar los campos del key, o se hace de uno en uno o mapeando
#Si la puntuacion es mayor, actualizamos el score del leaderboard
def update_score(id, points):
    games = r.hget( id,"games_played")
    print(games)
    games = int(games)
    games += 1
    r.hset(id, "score", points)
    pnt = r.zscore("leaderboard",id)
    if points > pnt:
        #Si es mayor el score, lo actualizamos
        r.zrem("leaderboard",id)
        r.zadd("leaderboard",{id:points})
    else:
        pass
    r.hset(id,"games_played",games)
update_score("player:1",101)
update_score("player:2",43)
update_score("player:3",53)
update_score("player:4",102)
```

    0
    0
    0
    0



```python
# Muestra todos los datos almacenados en el hash player:<id>
def player_info(id):
    print(r.hgetall(id))
player_info("player:1")
```

    {'name': 'angel', 'country': 'España', 'score': '101', 'games_played': '1'}



```python
#Muestra los n mejores jugadores del ranking (leaderboard) con nombre, país y puntuación de cada jugador.
#Los mejores puntuaciones se guardan al final de la lista
def show_top_players(n):
    print(r.zrevrange("leaderboard",0,n -1))
show_top_players(2)

```

    ['player:4', 'player:1']



```python
#Cada vez que un jugador inicia sesión, añadir su ID al HyperLogLog diario.
from datetime import date
diario = date.today().isoformat()
def register_login(player_id):
    r.pfadd(diario, player_id)
register_login("player:1")
register_login("player:2")
register_login("player:3")
register_login("player:4")


```


```python
#Obtiene el número aproximado de jugadores únicos que se conectaron ese día usando:
def  count_unique_logins(date):
    print(r.pfcount(date))
count_unique_logins("2025-11-11")


```

    4



```python
def weekly_report(dates):
    keys_to_merge = dates  

    report_key = "unique:players:week"

    r.pfmerge(report_key, *keys_to_merge)

    total_unique = r.pfcount(report_key)

    r.delete(report_key)

    return total_unique
weekly_report(["2025-11-11", "2025-11-12", "2025-11-13"])

```




    4




```python
print(diario)
```

    2025-11-17

